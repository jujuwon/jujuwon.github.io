{"componentChunkName":"component---src-templates-blog-post-js","path":"/Container/lxc/","result":{"data":{"site":{"siteMetadata":{"title":"Juwon's blog","author":"Juwon Lee","siteUrl":"https://gatsby-starter-bee.netlify.com","comment":{"disqusShortName":"","utterances":"JaeYeopHan/gatsby-starter-bee"},"sponsor":{"buyMeACoffeeId":"jbee"}}},"markdownRemark":{"id":"a42d8fd1-5ec2-5a1a-b8d5-cdd9dbcd3b18","excerpt":"Cgroup 과 Namespace 를 이용하면 Container 를 실현할 수 있다. Container 는 하나의 커널에서 관리하는 리소스를 복수의 그룹으로 분할한다. Container 에서 CPU 나 Memory 리소스는 Cgroup 으로 분할하고 PID 나 IPC, 네트워크와 같은 자원은 Namespace 로 분할한다. Cgroup Control Groups provide a mechanism for aggregating/partitioning sets of tasks, and all…","html":"<p>Cgroup 과 Namespace 를 이용하면 Container 를 실현할 수 있다.</p>\n<p>Container 는 하나의 커널에서 관리하는 리소스를 복수의 그룹으로 분할한다.</p>\n<p>Container 에서 CPU 나 Memory 리소스는 Cgroup 으로 분할하고</p>\n<p>PID 나 IPC, 네트워크와 같은 자원은 Namespace 로 분할한다.</p>\n<h2 id=\"cgroup\" style=\"position:relative;\"><a href=\"#cgroup\" aria-label=\"cgroup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cgroup</h2>\n<ul>\n<li>\n<p>Control Groups provide a mechanism for aggregating/partitioning</p>\n<p>sets of tasks, and all their future children,</p>\n<p>into hierarchical groups with specialized behaviour.</p>\n<p>A <em>cgroup</em> associates a set of tasks with</p>\n<p>a set of parameters for one or more subsystems.</p>\n</li>\n</ul>\n<br>\n<p><strong>프로세스를 그룹화</strong>해서 관리하기 위한 리눅스 커널의 기능이다.</p>\n<p>cgroup 자체는 프로세스를 그룹화하기 위한 기능과</p>\n<p>인터페이스를 제공하기 위한 인프라이고,</p>\n<p>이를 이용해 I/O 나 메모리 할당 제어 같은 구체적인 리소스 관리 기능이 구현된다.</p>\n<p>구체적인 리소스 관리 기능은 cgroup subsystem 또는 컨트롤러 라고 한다.</p>\n<ul>\n<li>\n<p>cgroup subsystem 의 종류</p>\n<p><strong>Memory 컨트롤러</strong> (메모리 제어), <strong>CPU 컨트롤러</strong> (프로세스 스케줄링 제어) 등</p>\n<p>실행 중인 커널에서 이용 가능한 cgroup subsystem 은 <code class=\"language-text\">/proc/cgroups</code> 에서</p>\n<p>확인이 가능하다.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 509px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABmklEQVQoz42SV1MCQRCE7wExlQgqYCiSZLgjXCTrcSA5WFjl//8l7cwAVcoD8jAFt7vzbU/3KnPNw3djgXV9hGVlgHG+CzfhYJLvYUl7K1qbFHoY57roPeuwQ2U0HjQ0wxU49yqql2kYN3l0HutoRSpQVgT6Mqfwkg5mJRfOXVkOjLIdOeClmrJW8sVhBgpw47aUl2rgPWaicvFK+yqG6basK8vaEG7MkiYGqP4kzNsCqXpD/ToLneA27bESLo32NX9KzvFv7SojUPUsKXvKxppirvbRezFkDO08JZB1bQQ7WIRFxZdxEzcfFl/y+1vZ2DMsyq7A2IctMIdPsoJhrPYY8LCUtb4NY5TroJ+wtyaTV+ynQWCG2gfAQ1V/gFMad6l6EkI7WhUvGpReO1qT/3aoJMXAvY/HoKJwQEmySk6aR2ZVnBgb36Qn0gpvw7KCJbHg2Pj0bD6wrg4FyCFwcqyw+1RH2ZfYvTlNgKz0X6CEQmMzoBWp7pQUMcy05QCr2ody4shjCYMbWA2PbATydIEuTQy3dh6eEsoPCyJB4bKP1m8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot from 2021 12 29 16 03 33\"\n        title=\"Screenshot from 2021 12 29 16 03 33\"\n        src=\"/static/edb3fef285d05a587f19b515a08030c1/71554/Screenshot_from_2021-12-29_16-03-33.png\"\n        srcset=\"/static/edb3fef285d05a587f19b515a08030c1/5a46d/Screenshot_from_2021-12-29_16-03-33.png 300w,\n/static/edb3fef285d05a587f19b515a08030c1/71554/Screenshot_from_2021-12-29_16-03-33.png 509w\"\n        sizes=\"(max-width: 509px) 100vw, 509px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n</li>\n</ul>\n<p>cgroup 은 <strong>그룹관리나 각 subsystem 을 설정하기 위한 인터페이스</strong>로</p>\n<p>cgroup 파일 시스템이라는 <strong>가상 파일시스템</strong>을 제공하고 있다.</p>\n<p>따라서 cgroup 을 사용하기 위해서는 cgroup 파일 시스템을 mount 해야 한다.</p>\n<p>이 때 mount 옵션으로 어떤 subsystem 을 사용할 것인지를 지정한다.\n<br />\n<br /></p>\n<h3 id=\"cgroup-생성\" style=\"position:relative;\"><a href=\"#cgroup-%EC%83%9D%EC%84%B1\" aria-label=\"cgroup 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cgroup 생성</h3>\n<hr>\n<p>간단한 예제로 root 경로에 cgroup 이라는 디렉토리를 만들고,</p>\n<p>cgroup 의 memory 컨트롤러를 mount 시켜보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /cgroup\n<span class=\"token function\">mount</span> -t cgroup -o memory cgroup /cgroup\n<span class=\"token builtin class-name\">cd</span> /cgroup\n<span class=\"token function\">ls</span></code></pre></div>\n<p>mount 명령어의 옵션을 살펴보면 파일시스템은 -t 옵션으로</p>\n<p>cgroup 가상 파일시스템으로 지정한다.</p>\n<p>-o 옵션에서 cgroup 하위의 memory 컨트롤러를 지정한 뒤</p>\n<p>cgroup 을 임의로 만든 /cgroup 디렉토리에 mount 시킨다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 612px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAACPUlEQVQoz21TWXPaYAz0S3M0bXokJGmag/s2n8HYGBuDAQMGcwXaJpPp//8bW0mENNPpg+bzg7TaXa21dX2C370tNmaEeaWPTSPCJNfBtNiTb+/SQDuho39nw71Q6N000bmqw79uSDU+5KCOMzDeZ+XVJnkfP+0Y00IXYaqNYcoRwDGVd6lgfiyg+alIVUL9JAfrcxnmaYHekry1wxRqR2kB5NIeiAUDMpt5dSDf2+aU2NSoOS1bdRpyznWMsx1hN7hvoUvshklHmO+A0wKsbUnqWo3wQNJnpZ40s6y9BH71gxQGNPzcWYsta2OMH9ZMSCyIxIrmeY4VaYN8gEHaQ3BjIrizBMxN1GC8gHHxZpe8jEuBDO487qL33YRxQj1khf2FrShCszNDNG99WNcOmuQLs1JvwPYM+wT01F6RikCYrY0RFvpQZNtfK+TvbrH26CwRlwMs1Vg8nNF1eRuDKDabGtnDgLx6bC2EHQMFt5ZcmT1lH5vETq48K/XJbE+uPMp45NFAmvkoLdrMW7m8K5Jc7svwSoXU60ofX1s/SL6q0p7cNVa1kK47x1IPxWA+FOeQj8SeimQCenZX4t22MaGeqaQhpJipozc5/OUsRPKGGvhiSwLnBf63OoU2L/mrvkvCoUMtjAhxNUSsjyRCouDwbwZ3kssvkokRN7EUDnhEFrCfUcGXq9sJBT8TwEw0YF6YqB1nJdR7oP9IjkXuTvIUHPgNSYvoT3LOqrDOFdx7D/UzA+q08hqrfxPxB0k5dxcT4dyRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot from 2021 12 29 16 10 52\"\n        title=\"Screenshot from 2021 12 29 16 10 52\"\n        src=\"/static/deaa3ac23ee7427e195b23effc0969c6/8c76f/Screenshot_from_2021-12-29_16-10-52.png\"\n        srcset=\"/static/deaa3ac23ee7427e195b23effc0969c6/5a46d/Screenshot_from_2021-12-29_16-10-52.png 300w,\n/static/deaa3ac23ee7427e195b23effc0969c6/0a47e/Screenshot_from_2021-12-29_16-10-52.png 600w,\n/static/deaa3ac23ee7427e195b23effc0969c6/8c76f/Screenshot_from_2021-12-29_16-10-52.png 612w\"\n        sizes=\"(max-width: 612px) 100vw, 612px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>위와 같이 cgroup 의 memory 컨트롤러가 나타내는 특수 파일들이 보이는 것을</p>\n<p>확인할 수 있다.</p>\n<p>mount 할 때 지정하는 옵션, 즉 어떤 subsystem 을 사용할지에 따라</p>\n<p>존재하는 파일은 달라진다.</p>\n<p>파일에는 readonly 파일과 읽기/쓰기 가능한 것이 있다.</p>\n<p>readonly 파일은 유저에게 정보를 제공하기 위한 파일이고,</p>\n<p>읽기/쓰기 가능한 파일은 값을 써서 cgroup 및 cgroup subsystem 의 설정을</p>\n<p>변경하기 위한 파일이다.</p>\n<p>특수 파일 중에서 가장 중요한 것은 tasks 라는 파일이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 274px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.715328467153284%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABD0lEQVQoz61R0U7CQBC8RJEgKg+aGAOhFQpF6LWVa3pICgcFC9hUpBgeNP7/Z4x3hUcVEnmY7M7cziR7S6LmEEsa4iNY4UuskbIFNjxB/CAQ6hyp94KlPUXcHuNzkOLNnmBU5dj4Mfq3Ll7pFGs/wTuL4JVaIHNTYFRh0tzDrBlgrHGEEoO7LnrXFiIj2PKyh7k5xNONlQWFmg92ZUJUPOnxIcoM7NIEUQZ6pqOT09A51WDltlCana/tND3j7ZMqqNRo/j7TnEIdltRVr6ri5LneR/eiAffcgFvc1d9QNP5+lyCLlsCjHFTp+4YPAYkaQdYcLTCRV1JhzhHCflzZKfwzcOXFmNW4vLJ+0KfvwzctewJ6EhlnJAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot from 2021 12 29 16 22 05\"\n        title=\"Screenshot from 2021 12 29 16 22 05\"\n        src=\"/static/9d600eb7ad0752efa0b6fd2bec00176d/d3fa7/Screenshot_from_2021-12-29_16-22-05.png\"\n        srcset=\"/static/9d600eb7ad0752efa0b6fd2bec00176d/d3fa7/Screenshot_from_2021-12-29_16-22-05.png 274w\"\n        sizes=\"(max-width: 274px) 100vw, 274px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>tasks 파일 안에 나열되어 있는 숫자는 이 <em>그룹</em> 에 속해있는 쓰레드의 TID 이다.</p>\n<p>시스템에서 실행되고 있는 모든 쓰레드의 TID 가 /cgroup/tasks 에 포함되어 있다.</p>\n<p>여기서 <em>그룹</em> 이란, cgroup 파일시스템의 디렉토리로 표현되는 쓰레드의 집합이다.</p>\n<p>디렉토리 하나가 하나의 <em>그룹</em> 이라고 표현할 수도 있다.</p>\n<p>cgroup 을 mount 하기 위해 /cgroup 이라는 디렉토리를 만들었는데,</p>\n<p>/cgroup 역시 디렉토리이므로 하나의 그룹을 나타내고 있다.</p>\n<p>여기서 /cgroup 은 mount point 의 최상위에 있는 디렉토리이고 자동으로</p>\n<p>생성되는 그룹으로, root group 이라고 한다.</p>\n<p>이 단계에서는 /cgroup, 즉 root group 만이 시스템에 존재하는 유일한 그룹이다.</p>\n<p>kernel 은 cgroup 이라는 특별한 파일 시스템을 통해 그룹을 만들고</p>\n<p>조작할 수 있게 제공한다.</p>\n<p>따라서 mount 한 /cgroup 디렉토리 아래 새로운 하위 디렉토리를 만들면</p>\n<p>새로운 <em>그룹</em> 을 만들 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> /cgroup/newgroup\n<span class=\"token function\">ls</span> /cgroup/newgroup</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 1071px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAwUlEQVQI1x2P2Q6CUAxEeTRG475EY4KaEES5LIKAKIKIKAZR/P9vGXvvQx/amU5PpXr/xJvdUBl3FGqEbB2ith8o9RSnqQV/qMPpqLDbCo5jJvpwYuLQ08AaK3j9LYIREzrvpcrIUGxiJAsXZnMtFj40e2kJyt0V6dKHP9hRiCGOvKme6gUx+QPy5soZXyvHx7zjKnuQfk4hTDwgHBuI5g4R5oKaB3LaVPZxntnii4rmHOA0NWG3FFzIH5HG6d3uBn8feWAN5UHDfwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot from 2021 12 29 17 23 51\"\n        title=\"Screenshot from 2021 12 29 17 23 51\"\n        src=\"/static/2f1012d47e95075f1c6587e0653cc364/705cc/Screenshot_from_2021-12-29_17-23-51.png\"\n        srcset=\"/static/2f1012d47e95075f1c6587e0653cc364/5a46d/Screenshot_from_2021-12-29_17-23-51.png 300w,\n/static/2f1012d47e95075f1c6587e0653cc364/0a47e/Screenshot_from_2021-12-29_17-23-51.png 600w,\n/static/2f1012d47e95075f1c6587e0653cc364/705cc/Screenshot_from_2021-12-29_17-23-51.png 1071w\"\n        sizes=\"(max-width: 1071px) 100vw, 1071px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>새로 생성한 디렉토리 (cgroup) 에는 상위 디렉토리와 마찬가지로</p>\n<p>특수 파일들을 kernel 이 자동으로 생성한다.</p>\n<blockquote>\n<p>단, release_agent 파일은 최상위 cgroup 에만 존재</p>\n</blockquote>\n<p>새로 생성한 cgroup 의 tasks 를 확인해보면 내부가 비어있는 것을 알 수 있다.</p>\n<p>아직 이 그룹에 쓰레드가 하나도 속해있지 않기 때문이다.</p>\n<p>적당한 쓰레드를 이 그룹에 소속시켜보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$$</span> <span class=\"token comment\"># 사용하고 있는 shell 의 pid값 출력</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$$</span> <span class=\"token operator\">></span> /cgroup/newgroup/tasks\n<span class=\"token function\">cat</span> /cgroup/newgroup/tasks</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 567px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA3UlEQVQY02VP2wqCUBD0pbSC6CGCKCot0y5qNzPNS9rdIggKeuj/f2PacxJ66GGY3Z2dOXuExyLFqe8jqM8Qt5dIOg52ikvwkLQdxC2b5g6ixhyTYg/jXOcPRl6GIcqwCl0IL/eG6yhG1FzwkH3Xw0kL6JGA6jX2FL6VVzzcq1l8J9VD2glx1iOciXekM59dGUB42hfcjIQuWeKo+jwoHUS4DGMcqT7Q4oY0ZtjKLp+lWRCrGbvVMeZlDdOSCuEd3ilZ52ebksLBzjfFrM/YYqAvmaLyhfRlQ/z5mP4Boeh6ShiuR3sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot from 2021 12 29 17 30 45\"\n        title=\"Screenshot from 2021 12 29 17 30 45\"\n        src=\"/static/778ee6b6543d2d3ac7bce30c471617c7/8710b/Screenshot_from_2021-12-29_17-30-45.png\"\n        srcset=\"/static/778ee6b6543d2d3ac7bce30c471617c7/5a46d/Screenshot_from_2021-12-29_17-30-45.png 300w,\n/static/778ee6b6543d2d3ac7bce30c471617c7/8710b/Screenshot_from_2021-12-29_17-30-45.png 567w\"\n        sizes=\"(max-width: 567px) 100vw, 567px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>tasks 의 내용에 shell 의 TID (PID 이기도 함) 인 514181 이 포함되어 있다는 것을 통해</p>\n<p>shell 이 newgroup 에 소속되어 있음을 알 수 있다.</p>\n<p>그런데 이 그룹에는 514796 이라는 쓰레드가 하나 더 소속되어 있다.</p>\n<p>tasks 의 내용을 한 번 더 출력해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 506px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 11.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsSAAALEgHS3X78AAAAdElEQVQI12Pw0nT4H2bu899X1+W/k7z5fxcly/8eanb/3VVt/ntp2gPZtv9BahzkTP/bSxv/d1W2BsuB1IDkIWzb/x7q9kB5o/8MPjrO/0NNvf5bCOv812FT+G/ApfJfn1MZjPU4lBA0hzJcHIyBYjB5ZLUAJjw9EHdwSEsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Screenshot from 2021 12 29 17 33 37\"\n        title=\"Screenshot from 2021 12 29 17 33 37\"\n        src=\"/static/5f851d6065c27e23b45c3bdbf850ef56/29f4e/Screenshot_from_2021-12-29_17-33-37.png\"\n        srcset=\"/static/5f851d6065c27e23b45c3bdbf850ef56/5a46d/Screenshot_from_2021-12-29_17-33-37.png 300w,\n/static/5f851d6065c27e23b45c3bdbf850ef56/29f4e/Screenshot_from_2021-12-29_17-33-37.png 506w\"\n        sizes=\"(max-width: 506px) 100vw, 506px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>두 번째 TID 가 변경된 것을 확인할 수 있다.</p>\n<p>이 부분은 tasks 의 내용을 출력시킨 cat 프로세스이다.</p>\n<p>첫 번째 cat 과 두 번째 cat 은 다른 프로세스이기 때문에 TID 가 달라서 결과가 달라졌다.</p>\n<h4 id=\"cat-프로세스를-newgroup-에-소속시킨-적이-없는데-\" style=\"position:relative;\"><a href=\"#cat-%ED%94%84%EB%A1%9C%EC%84%B8%EC%8A%A4%EB%A5%BC-newgroup-%EC%97%90-%EC%86%8C%EC%86%8D%EC%8B%9C%ED%82%A8-%EC%A0%81%EC%9D%B4-%EC%97%86%EB%8A%94%EB%8D%B0-\" aria-label=\"cat 프로세스를 newgroup 에 소속시킨 적이 없는데  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cat 프로세스를 newgroup 에 소속시킨 적이 없는데 ?</h4>\n<blockquote>\n<p>그 이유는 그룹에 소속되어 있는 프로세스가 자식 프로세스를 생성하면,</p>\n<p>해당 자식 프로세스는 자동으로 부모 프로세스의 그룹에 속하기 때문이다.</p>\n<p>cat 은 shell 의 자식 프로세스이므로 자동으로 newgroup 에 소속된 것이다.</p>\n</blockquote>\n<p>cgroup 파일시스템을 mount 한 직후에</p>\n<p>시스템의 모든 쓰레드가 root group 에 소속되어 있었던 것을 떠올려보면, 이해가 쉽다.</p>\n<p>이제 shell 의 TID (여기서는 514181) 를 root group 으로 되돌려보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token number\">514181</span> <span class=\"token operator\">></span> /cgroup/tasks</code></pre></div>\n<p>이제 /cgroup/newgroup/tasks 는 비게 되고,</p>\n<p>쓰레드가 하나도 소속되어 있지 않은 그룹은</p>\n<p>파기할 수 있다. 그룹은 디렉토리를 삭제함으로써 파기된다.\n<br />\n<br /></p>\n<h3 id=\"cgroup-제거\" style=\"position:relative;\"><a href=\"#cgroup-%EC%A0%9C%EA%B1%B0\" aria-label=\"cgroup 제거 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cgroup 제거</h3>\n<hr>\n<p>cgroup 을 제거할 때는 반대로 디렉토리를 제거하면 된다.</p>\n<p>다만 cgroup 에 속한 task 가 없어야 가능하다.</p>\n<p>제거하고자 하는 그룹 디렉토리 안의 notify<em>on</em>release 파일의 값을 1로 세팅해주면,</p>\n<p>release_agent 로 지정된 프로그램에게 알려준다.</p>\n<p>release_agent 로 사용할 프로그램을 shell script 를 이용해서</p>\n<p>/release.sh 이라는 이름으로 작성해보았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token builtin class-name\">echo</span> cgroup <span class=\"token variable\">$1</span> released<span class=\"token operator\">!</span> <span class=\"token operator\">></span> /tmp/cgroup-release-msg</code></pre></div>\n<p>release_agent 는 커널이 background 에서 실행시키기 때문에</p>\n<p>echo 를 이용해 메시지를 출력해도 터미널에서는 볼 수 없다.</p>\n<p>여기서는 특정 파일에 기록하도록 하였다.</p>\n<p>이제 실행권한을 주고 release_agent 로 등록한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> +x /release.sh\n<span class=\"token builtin class-name\">echo</span> /release.sh <span class=\"token operator\">></span> /cgroup/release_agent</code></pre></div>\n<p>notify<em>on</em>release 를 1로 세팅한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> /cgroup/newgroup/notify_on_release</code></pre></div>\n<p>그룹을 바로 삭제한다고 release_agent 가 호출되지는 않는다.</p>\n<p>해당 그룹에서 하나 이상의 동작이 이루어져야 notify 기능이 활성화된다.</p>\n<p>삭제를 위해 간단히 task 를 그룹에 추가한 후에 다시 제거한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$$</span> <span class=\"token operator\">></span> /cgroup/newgroup/tasks\n<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$$</span> <span class=\"token operator\">></span> /cgroup/tasks</code></pre></div>\n<p>이제 newgroup 그룹을 삭제해보면 release_agent 가 실행되었음을 확인할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">rmdir</span> /cgroup/newgroup\n<span class=\"token function\">cat</span> /tmp/cgroup-release-msg</code></pre></div>\n<p>참고로 subsystem 공통으로 cgroup 이 제공하는 특수 파일 목록은</p>\n<p>다음과 같다.</p>\n<table>\n<thead>\n<tr>\n<th>파일명</th>\n<th align=\"center\">R/W</th>\n<th>용도</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>release_agent</td>\n<td align=\"center\">RW</td>\n<td>그룹이 삭제될 때 실행할 명령. 이 파일은 root 그룹에만 존재</td>\n</tr>\n<tr>\n<td>notify _on _release</td>\n<td align=\"center\">RW</td>\n<td>release_agent 를 실행할지 여부 설정. 1이면 실행</td>\n</tr>\n<tr>\n<td>tasks</td>\n<td align=\"center\">RW</td>\n<td>그룹에 속하는 쓰레드의 PID 목록</td>\n</tr>\n<tr>\n<td>cgroup.procs</td>\n<td align=\"center\">R</td>\n<td>그룹에 속하는 프로세스의 PID 목록. 멀티 쓰레드 프로세스의 쓰레드 그룹 리더 이외의 TID 는 포함되지 않는다.</td>\n</tr>\n<tr>\n<td>cgroup.event_control</td>\n<td align=\"center\">RW</td>\n<td>상태 갱신이나 그룹 삭제를 이벤트로 감시하기 위한 설정용 파일</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"namespace\" style=\"position:relative;\"><a href=\"#namespace\" aria-label=\"namespace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Namespace</h2>\n<p>Namespace 를 사용하면 프로세스 그룹별로 독립된 PID 나, IPC,</p>\n<p>네트워크 공간을 가질 수 있다.</p>\n<p><code class=\"language-text\">clone</code> 시스템콜을 호출할 때 플래그를 설정하면 namespace 를 분할할 수 있다.</p>\n<p>예를 들어 PID namespace 를 분할하면 새롭게 만들어진 namespace 에서</p>\n<p>프로세스의 PID 는 1부터 시작한다.</p>\n<p>PID 가 1인 새로운 프로세스로부터 fork() 된 프로세스는 이 새로운 PID namespace 에 갇혀서</p>\n<p>다른 PID namespace 와는 단절된다.</p>\n<p>그 전에 생성한 PID namespace 에 존재하는 프로세스와 같은 PID 를 가질 수도 있지만,</p>\n<p>namespace 가 분할되어 있으므로 서로에게 영향을 주지는 않는다.</p>\n<p>마찬가지로 IPC, Network, File System mount 공간, UTS (Universal Time sharing System) 를</p>\n<p>대상으로 리소스 분할이 가능하다.</p>\n<br>\n<ul>\n<li>리소스 분할</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>이름</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CLONE_NEWIPC</td>\n<td>IPC 간 namespace 분할. 세마포어나 공유메모리, 메시지큐 등 프로세스 간 통신에 쓰이는 리소스를 할당.</td>\n</tr>\n<tr>\n<td>CLONE_NEWNET</td>\n<td>네트워크 namespace 를 분할. 네트워크 인터페이스를 할당.</td>\n</tr>\n<tr>\n<td>CLONE_NEWNS</td>\n<td>마운트 이름을 분할. chroot 와 마찬가지로 새로운 root filesystem 을 할당.</td>\n</tr>\n<tr>\n<td>CLONE_NEWPID</td>\n<td>PID namespace 를 분할. 새로운 PID 공간을 할당.</td>\n</tr>\n<tr>\n<td>CLONE_NEWUTS</td>\n<td>UTS namespace 를 분할. 새로운 UTS 공간을 할당</td>\n</tr>\n</tbody>\n</table>\n<br>\n<hr>\n<p>[참고 URL]</p>\n<ul>\n<li><a href=\"https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/cgroups.html\">https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/cgroups.html</a></li>\n<li><a href=\"http://egloos.zum.com/studyfoss/v/5505982\">http://egloos.zum.com/studyfoss/v/5505982</a></li>\n</ul>\n<p>[참고 서적]</p>\n<ul>\n<li>리눅스 커널 HACKS (다카하시 히로카즈 감수)</li>\n</ul>","frontmatter":{"title":"LXC - Linux Container","date":"January 03, 2022"}}},"pageContext":{"slug":"/Container/lxc/","previous":null,"next":{"fields":{"slug":"/WEB/rest-api/"},"frontmatter":{"title":"REST API 란"}}}},"staticQueryHashes":["2486386679","3128451518"]}